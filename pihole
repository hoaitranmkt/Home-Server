#!/bin/bash
set -e

GREEN='\033[0;32m'
NC='\033[0m'

echo -e "${GREEN}ðŸš€ Báº¯t Ä‘áº§u cÃ i Ä‘áº·t láº¡i Pi-hole báº±ng Docker...${NC}"

# Dá»«ng vÃ  xÃ³a container Pi-hole náº¿u Ä‘ang cháº¡y
if docker ps -a --format '{{.Names}}' | grep -qw pihole; then
  echo -e "${GREEN}ðŸ›‘ Dá»«ng vÃ  xÃ³a container Pi-hole cÅ©...${NC}"
  docker stop pihole
  docker rm pihole
else
  echo -e "${GREEN}â„¹ï¸ KhÃ´ng tÃ¬m tháº¥y container Pi-hole cÅ© Ä‘ang cháº¡y.${NC}"
fi

# XÃ³a dá»¯ liá»‡u cÅ©
echo -e "${GREEN}ðŸ§¹ XÃ³a dá»¯ liá»‡u Pi-hole cÅ©...${NC}"
sudo rm -rf ~/services/pihole

# Táº¡o thÆ° má»¥c má»›i
echo -e "${GREEN}ðŸ“ Táº¡o thÆ° má»¥c lÆ°u dá»¯ liá»‡u má»›i...${NC}"
mkdir -p ~/services/pihole/{etc-pihole,etc-dnsmasq.d}
cd ~/services/pihole

# Táº¡o docker-compose.yml
echo -e "${GREEN}âš™ï¸ Táº¡o file docker-compose.yml...${NC}"
cat > docker-compose.yml <<EOF
version: "3"

services:
  pihole:
    container_name: pihole
    image: pihole/pihole:latest
    network_mode: host
    environment:
      TZ: 'Asia/Ho_Chi_Minh'
      WEBPASSWORD: 'changeme'
    volumes:
      - ./etc-pihole:/etc/pihole
      - ./etc-dnsmasq.d:/etc/dnsmasq.d
    restart: unless-stopped
EOF

# Khá»Ÿi Ä‘á»™ng Pi-hole
echo -e "${GREEN}ðŸš€ Khá»Ÿi Ä‘á»™ng Pi-hole...${NC}"
docker compose up -d

# Hiá»ƒn thá»‹ thÃ´ng tin truy cáº­p
LOCAL_IP=$(hostname -I | awk '{print $1}')
echo -e "${GREEN}âœ… Pi-hole Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t láº¡i thÃ nh cÃ´ng!${NC}"
echo -e "${GREEN}ðŸŒ Truy cáº­p web quáº£n lÃ½ táº¡i: http://${LOCAL_IP}/admin${NC}"
echo -e "${GREEN}ðŸ” Máº­t kháº©u Ä‘Äƒng nháº­p máº·c Ä‘á»‹nh: changeme${NC}"
echo -e "${GREEN}ðŸ’¡ Báº¡n cÃ³ thá»ƒ Ä‘á»•i máº­t kháº©u báº±ng lá»‡nh:\n  docker exec -it pihole pihole -a setpassword 'máº­t kháº©u_má»›i'${NC}"
