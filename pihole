#!/bin/bash
set -e

GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${GREEN}ðŸ”§ Báº¯t Ä‘áº§u cÃ i Ä‘áº·t Pi-hole trÃªn Home Server...${NC}"

# ===========================
# 1. Kiá»ƒm tra & cÃ i Docker
# ===========================
if ! command -v docker &> /dev/null; then
  echo -e "${GREEN}ðŸ³ CÃ i Ä‘áº·t Docker...${NC}"
  curl -fsSL https://get.docker.com | sh
else
  echo -e "${GREEN}âœ… Docker Ä‘Ã£ Ä‘Æ°á»£c cÃ i sáºµn${NC}"
fi

# ===========================
# 2. Kiá»ƒm tra & cÃ i Docker Compose (v2)
# ===========================
if ! command -v docker compose &> /dev/null; then
  echo -e "${GREEN}ðŸ“¦ CÃ i Ä‘áº·t Docker Compose...${NC}"
  DOCKER_CONFIG=${DOCKER_CONFIG:-$HOME/.docker}
  mkdir -p $DOCKER_CONFIG/cli-plugins
  curl -SL https://github.com/docker/compose/releases/download/v2.27.1/docker-compose-linux-x86_64 -o $DOCKER_CONFIG/cli-plugins/docker-compose
  chmod +x $DOCKER_CONFIG/cli-plugins/docker-compose
else
  echo -e "${GREEN}âœ… Docker Compose Ä‘Ã£ sáºµn sÃ ng${NC}"
fi

# ===========================
# 3. XÃ¡c Ä‘á»‹nh IP ná»™i bá»™
# ===========================
PIHOLE_IP=$(ip route get 1 | awk '{print $7; exit}')
if [[ -z "$PIHOLE_IP" ]]; then
  echo -e "${RED}âŒ KhÃ´ng xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c IP ná»™i bá»™!${NC}"
  exit 1
fi
echo -e "${GREEN}ðŸŒ IP ná»™i bá»™ cá»§a Pi-hole: $PIHOLE_IP${NC}"

# ===========================
# 4. Nháº­p máº­t kháº©u Web UI
# ===========================
echo -ne "${GREEN}ðŸ”‘ Nháº­p máº­t kháº©u truy cáº­p Web UI Pi-hole:${NC} "
read PIHOLE_PASS_1
echo -ne "${GREEN}ðŸ” Nháº­p láº¡i máº­t kháº©u Ä‘á»ƒ xÃ¡c nháº­n:${NC} "
read PIHOLE_PASS_2
echo

if [[ "$PIHOLE_PASS_1" != "$PIHOLE_PASS_2" ]]; then
  echo -e "${RED}âŒ Máº­t kháº©u khÃ´ng khá»›p. ThoÃ¡t.${NC}"
  exit 1
fi

if [[ -z "$PIHOLE_PASS_1" ]]; then
  PIHOLE_PASS="changeme"
  echo -e "${GREEN}âš ï¸ KhÃ´ng nháº­p máº­t kháº©u â†’ DÃ¹ng máº·c Ä‘á»‹nh: changeme${NC}"
else
  PIHOLE_PASS="$PIHOLE_PASS_1"
fi

# ===========================
# 5. Thiáº¿t láº­p thÆ° má»¥c & timezone
# ===========================
PIHOLE_DIR="$HOME/pihole"
TIMEZONE="Asia/Ho_Chi_Minh"

mkdir -p "$PIHOLE_DIR/etc-pihole"
mkdir -p "$PIHOLE_DIR/etc-dnsmasq.d"

# Cho phÃ©p truy cáº­p tá»« cÃ¡c mÃ¡y khÃ¡c trong máº¡ng (fix lá»—i non-local network)
cat > "$PIHOLE_DIR/etc-dnsmasq.d/02-lan-access.conf" <<EOF
interface=eth0
local-service
EOF

# ===========================
# 6. Táº¡o docker-compose.yml
# ===========================
echo -e "${GREEN}ðŸ“ Táº¡o file docker-compose.yml...${NC}"
cat > "$PIHOLE_DIR/docker-compose.yml" <<EOF
version: "3"

services:
  pihole:
    container_name: pihole
    image: pihole/pihole:latest
    restart: unless-stopped
    network_mode: "host"
    environment:
      TZ: "$TIMEZONE"
      WEBPASSWORD: "$PIHOLE_PASS"
      FTLCONF_LOCAL_IPV4: "$PIHOLE_IP"
    volumes:
      - ./etc-pihole:/etc/pihole
      - ./etc-dnsmasq.d:/etc/dnsmasq.d
    cap_add:
      - NET_ADMIN
EOF

# ===========================
# 7. Khá»Ÿi Ä‘á»™ng Pi-hole
# ===========================
echo -e "${GREEN}ðŸš€ Khá»Ÿi Ä‘á»™ng Pi-hole...${NC}"
cd "$PIHOLE_DIR"
docker compose up -d

# ===========================
# 8. Táº¡o mÃ£ QR truy cáº­p
# ===========================
echo -e "${GREEN}ðŸ“± Táº¡o mÃ£ QR truy cáº­p Web UI...${NC}"

if ! command -v qrencode &> /dev/null; then
  sudo apt update && sudo apt install -y qrencode
fi

PIHOLE_URL="http://$PIHOLE_IP/admin"
qrencode -t UTF8 "$PIHOLE_URL"

# ===========================
# 9. HoÃ n táº¥t
# ===========================
echo -e "\n${GREEN}âœ… CÃ i Ä‘áº·t Pi-hole hoÃ n táº¥t!${NC}"
echo -e "ðŸ”— Truy cáº­p Web UI: $PIHOLE_URL"
echo -e "ðŸ”‘ Máº­t kháº©u: $PIHOLE_PASS"
